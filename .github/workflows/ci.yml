name: Dotfiles CI

on:
  push:
    branches: [ "001-dotfiles-setup", "main" ]
  pull_request:
    branches: [ "001-dotfiles-setup", "main" ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'

  test-install:
    name: Test Install on ${{ matrix.os }}
    needs: [shellcheck, markdown-lint]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      # Homebrew is pre-installed on macOS runners
      run: |
        brew update
        # Install chezmoi if not present
        if ! command -v chezmoi >/dev/null 2>&1; then
          brew install chezmoi
        fi

    - name: Install chezmoi (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin

    - name: Initialize and Apply Dotfiles
      run: |
        # Use 'time' to benchmarking installation (T026)
        # We use --source . to use the checked-out repo
        # We assume no secrets are strictly blocking for this basic CI smoke test
        
        echo "Starting Chezmoi Apply..."
        time chezmoi init --apply --source . --verbose

    - name: Run Validation Script
      run: |
        chmod +x scripts/validate-installation.sh
        ./scripts/validate-installation.sh

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: |
          home/
