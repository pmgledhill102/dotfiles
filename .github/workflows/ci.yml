name: Dotfiles CI

on:
  push:
    branches: [ "001-dotfiles-setup", "main" ]
  pull_request:
    branches: [ "001-dotfiles-setup", "main" ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'

  test-install:
    name: Test Install on ${{ matrix.os }}
    needs: [shellcheck, markdown-lint]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check disk space before installation
      run: |
        echo "==================================="
        echo "Disk Space Before Installation"
        echo "==================================="
        df -h
        echo ""
        echo "Home directory size:"
        du -sh "$HOME" 2>/dev/null || echo "Unable to calculate home directory size"
        echo ""
        # Store initial disk usage in bytes for accurate calculation
        INITIAL_HOME_SIZE=$(du -sb "$HOME" 2>/dev/null | awk '{print $1}')
        echo "$INITIAL_HOME_SIZE" > /tmp/initial_home_size.txt
        echo "Initial home directory size: $INITIAL_HOME_SIZE bytes"

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      # Homebrew is pre-installed on macOS runners
      run: |
        brew update
        # Install chezmoi if not present
        if ! command -v chezmoi >/dev/null 2>&1; then
          brew install chezmoi
        fi

    - name: Install chezmoi (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin

    - name: Initialize and Apply Dotfiles
      run: |
        # Use 'time' to benchmarking installation (T026)
        # We use --source . to use the checked-out repo
        # We assume no secrets are strictly blocking for this basic CI smoke test
        
        echo "Starting Chezmoi Apply..."
        time chezmoi init --apply --source . --verbose

    - name: Run Validation Script
      run: |
        chmod +x scripts/validate-installation.sh
        ./scripts/validate-installation.sh

    - name: Check disk space after installation
      run: |
        echo ""
        echo "==================================="
        echo "Disk Space After Installation"
        echo "==================================="
        df -h
        echo ""
        echo "Home directory size:"
        du -sh "$HOME" 2>/dev/null || echo "Unable to calculate home directory size"
        echo ""
        
        # Calculate disk overhead
        if [ ! -f /tmp/initial_home_size.txt ]; then
          echo "Error: Initial home size file not found"
          exit 1
        fi
        
        INITIAL_HOME_SIZE=$(cat /tmp/initial_home_size.txt)
        if ! [[ "$INITIAL_HOME_SIZE" =~ ^[0-9]+$ ]]; then
          echo "Error: Initial home size is not a valid number"
          exit 1
        fi
        
        FINAL_HOME_SIZE=$(du -sb "$HOME" 2>/dev/null | awk '{print $1}')
        OVERHEAD_BYTES=$((FINAL_HOME_SIZE - INITIAL_HOME_SIZE))
        
        # Handle sign separately for MB calculation to avoid truncation issues
        if [ $OVERHEAD_BYTES -ge 0 ]; then
          OVERHEAD_MB=$((OVERHEAD_BYTES / 1024 / 1024))
        else
          # For negative values, preserve the sign through division
          OVERHEAD_MB=$((OVERHEAD_BYTES / 1024 / 1024))
        fi
        
        echo "==================================="
        echo "Disk Space Overhead Summary"
        echo "==================================="
        echo "Initial home directory size: $(numfmt --to=iec-i --suffix=B $INITIAL_HOME_SIZE)"
        echo "Final home directory size:   $(numfmt --to=iec-i --suffix=B $FINAL_HOME_SIZE)"
        if [ $OVERHEAD_BYTES -ge 0 ]; then
          echo "Disk overhead:               $(numfmt --to=iec-i --suffix=B $OVERHEAD_BYTES) (${OVERHEAD_MB} MB)"
        else
          echo "Disk overhead:               -$(numfmt --to=iec-i --suffix=B $((-OVERHEAD_BYTES))) (${OVERHEAD_MB} MB) [negative - files were removed]"
        fi
        echo "==================================="
        
        # Also show breakdown of major directories
        echo ""
        echo "Top directories by size in home:"
        find "$HOME" -maxdepth 1 -exec du -sh {} + 2>/dev/null | sort -hr | head -20 || echo "Unable to list directories"

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: |
          home/
