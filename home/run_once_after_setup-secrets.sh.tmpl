#!/bin/bash
# setup-secrets — fetch development secrets from Bitwarden
# Runs once after chezmoi apply on personal machines only
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
set -euo pipefail

# {{ if ne .machine_type "personal" }}
echo "Not a personal machine — skipping secrets setup"
exit 0
# {{ end }}

# 1. Check bw CLI available
if ! command -v bw >/dev/null 2>&1; then
    echo "Bitwarden CLI not found — skipping secrets setup"
    exit 0
fi

# 2. Check if secrets already populated
if [ -f "$HOME/.secrets" ] && grep -q '[^[:space:]]' "$HOME/.secrets"; then
    echo "$HOME/.secrets already exists — skipping secrets setup"
    exit 0
fi

# 3. Prompt user (skip if not interactive)
if [ ! -t 0 ]; then
    echo "Non-interactive shell — skipping secrets setup"
    exit 0
fi

printf "Set up development secrets from Bitwarden? (y/n) "
read -r answer
if [ "$answer" != "y" ]; then
    echo "Skipping secrets setup"
    exit 0
fi

# 4. Handle login + unlock
if ! bw login --check >/dev/null 2>&1; then
    echo "Logging in to Bitwarden..."
    bw login
fi

BW_SESSION=$(bw unlock --raw)
export BW_SESSION

# 5. Fetch secrets and write file
NOTES=$(bw get notes "dotfiles-secrets")
echo "$NOTES" > "$HOME/.secrets"
chmod 600 "$HOME/.secrets"
echo "Secrets written to ~/.secrets"
