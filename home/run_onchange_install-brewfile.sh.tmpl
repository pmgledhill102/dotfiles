#!/bin/sh

# This script runs whenever the Brewfile changes (run_onchange)
# It installs/updates packages using brew bundle

set -e

case "$(uname -s)" in
  Darwin*)
    echo "macOS detected - running brew bundle..."
    
    if ! command -v brew >/dev/null 2>&1; then
      echo "Error: Homebrew is not installed. Please run the main install script first."
      exit 1
    fi
    
    # Use the Brewfile from the chezmoi source directory
    BREWFILE="{{ .chezmoi.sourceDir }}/Brewfile"
    
    if [ -f "$BREWFILE" ]; then
      echo "Installing packages from Brewfile at $BREWFILE..."
      brew bundle install --file "$BREWFILE" --no-lock || echo "Warning: Some packages may have failed to install"
    else
      echo "Warning: Brewfile not found at $BREWFILE"
      exit 1
    fi
    ;;
  *)
    echo "Not macOS - skipping brew bundle"
    ;;
esac
