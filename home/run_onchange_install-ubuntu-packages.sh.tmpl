#!/bin/sh
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"

# This script runs whenever the ubuntu_pkglist changes (run_onchange)
# It installs packages from the list on Linux systems

set -e

case "$(uname -s)" in
  Linux*)
    echo "Linux detected - installing packages from ubuntu_pkglist..."
    
    PKGLIST_FILE="$HOME/.config/ubuntu_pkglist"
    
    if [ ! -f "$PKGLIST_FILE" ]; then
      echo "Warning: Package list not found at $PKGLIST_FILE"
      exit 0
    fi
    
    export DEBIAN_FRONTEND=noninteractive
    sudo apt-get update
    
    echo "Installing packages from ubuntu_pkglist..."
    # Read package list and install (skip empty lines and comments)
    grep -v '^#' "$PKGLIST_FILE" | grep -v '^$' | while read -r package; do
      echo "Installing $package..."
      sudo apt-get install -y "$package" || echo "Warning: Failed to install $package"
    done
    
    # Install lazygit
    echo "Installing/Updating lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": *"v\K[^"]*')
    echo "Downloading lazygit v${LAZYGIT_VERSION}..."
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit -D -t /usr/local/bin/
    rm lazygit.tar.gz lazygit
    echo "lazygit installed successfully"

# {{ if ne .machine_type "minimal" }}
    # Install PowerShell from Microsoft repository
    echo "Installing/Updating PowerShell..."
    if ! command -v pwsh >/dev/null 2>&1; then
      sudo apt-get install -y wget apt-transport-https software-properties-common
      # shellcheck disable=SC1091
      . /etc/os-release
      wget -q "https://packages.microsoft.com/config/ubuntu/${VERSION_ID}/packages-microsoft-prod.deb"
      sudo dpkg -i packages-microsoft-prod.deb
      rm packages-microsoft-prod.deb
      sudo apt-get update
      sudo apt-get install -y powershell
      echo "PowerShell installed successfully"
    else
      echo "PowerShell already installed, skipping"
    fi
# {{ end }}

    # Install uv (Python package manager)
    echo "Installing/Updating uv..."
    if ! command -v uv >/dev/null 2>&1; then
      curl -LsSf https://astral.sh/uv/install.sh | sh
      echo "uv installed successfully"
    else
      echo "uv already installed, skipping"
    fi

    echo "Package installation complete"
    ;;
  *)
    echo "Not Linux - skipping apt package installation"
    ;;
esac
